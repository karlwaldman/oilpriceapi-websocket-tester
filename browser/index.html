<!doctype html>
<html>
  <head>
    <title>OilPriceAPI WebSocket Tester</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      h1 {
        color: #1a1a2e;
      }
      .controls {
        margin: 20px 0;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      input {
        width: 300px;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        background: #16213e;
        color: white;
      }
      button:hover {
        background: #0f3460;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .clear-btn {
        background: #6c757d;
      }
      .clear-btn:hover {
        background: #5a6268;
      }
      #status {
        padding: 8px 16px;
        border-radius: 4px;
        font-weight: bold;
      }
      .connected {
        background: #d4edda;
        color: #155724;
      }
      .disconnected {
        background: #f8d7da;
        color: #721c24;
      }
      .connecting {
        background: #fff3cd;
        color: #856404;
      }
      #log {
        background: #1a1a2e;
        color: #0f0;
        padding: 20px;
        height: 400px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.4;
      }
      .error {
        color: #ff6b6b;
      }
      .info {
        color: #6bcfff;
      }
      .price {
        color: #90ee90;
      }
      .log-count {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <h1>OilPriceAPI WebSocket Tester</h1>
    <p>
      Enter your API key to test the real-time price feed. Get your key at
      <a href="https://oilpriceapi.com/dashboard">oilpriceapi.com/dashboard</a>
    </p>

    <div class="controls">
      <input type="password" id="apiKey" placeholder="Your API Key" />
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
      <button id="clearBtn" class="clear-btn">Clear Log</button>
      <span id="status" class="disconnected">Disconnected</span>
    </div>

    <div id="log"></div>
    <div class="log-count">
      Messages: <span id="msgCount">0</span> (max 1000)
    </div>

    <script>
      // Configuration
      const DEFAULT_URL = "wss://api.oilpriceapi.com/cable";
      const CHANNEL = "EnergyPricesChannel";
      const CONNECTION_TIMEOUT_MS = 30000;
      const MAX_RECONNECT_ATTEMPTS = 5;
      const MAX_LOG_ENTRIES = 1000;

      let ws = null;
      let reconnectAttempts = 0;
      let connectionTimeout = null;
      let messageCount = 0;

      const log = document.getElementById("log");
      const status = document.getElementById("status");
      const connectBtn = document.getElementById("connectBtn");
      const disconnectBtn = document.getElementById("disconnectBtn");
      const clearBtn = document.getElementById("clearBtn");
      const msgCount = document.getElementById("msgCount");

      // Use addEventListener instead of inline handlers
      connectBtn.addEventListener("click", connect);
      disconnectBtn.addEventListener("click", disconnect);
      clearBtn.addEventListener("click", clearLog);

      function addLog(msg, cls = "") {
        // Rotate log if too many entries
        while (log.children.length >= MAX_LOG_ENTRIES) {
          log.removeChild(log.firstChild);
        }

        const div = document.createElement("div");
        div.className = cls;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;

        messageCount++;
        msgCount.textContent = Math.min(messageCount, MAX_LOG_ENTRIES);
      }

      function clearLog() {
        log.innerHTML = "";
        messageCount = 0;
        msgCount.textContent = "0";
        addLog("Log cleared", "info");
      }

      function setStatus(state) {
        if (state === "connected") {
          status.textContent = "Connected";
          status.className = "connected";
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
        } else if (state === "connecting") {
          status.textContent = "Connecting...";
          status.className = "connecting";
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
        } else {
          status.textContent = "Disconnected";
          status.className = "disconnected";
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
        }
      }

      function connect() {
        const apiKey = document.getElementById("apiKey").value;
        if (!apiKey) {
          addLog("Please enter your API key", "error");
          return;
        }

        reconnectAttempts = 0;
        doConnect(apiKey);
      }

      function doConnect(apiKey) {
        setStatus("connecting");
        addLog("Connecting to OilPriceAPI WebSocket...", "info");

        ws = new WebSocket(`${DEFAULT_URL}?token=${apiKey}`);

        // Set connection timeout
        connectionTimeout = setTimeout(() => {
          if (ws.readyState !== WebSocket.OPEN) {
            addLog("Connection timeout after 30 seconds", "error");
            ws.close();
            handleReconnect(apiKey);
          }
        }, CONNECTION_TIMEOUT_MS);

        ws.onopen = () => {
          clearTimeout(connectionTimeout);
          reconnectAttempts = 0;
          setStatus("connected");
          addLog("Connected! Subscribing to " + CHANNEL + "...", "info");
          ws.send(
            JSON.stringify({
              command: "subscribe",
              identifier: JSON.stringify({ channel: CHANNEL }),
            }),
          );
        };

        ws.onmessage = (e) => {
          try {
            const msg = JSON.parse(e.data);
            if (msg.type === "ping") return;
            if (msg.type === "welcome") {
              addLog("Server welcomed connection", "info");
              return;
            }
            if (msg.type === "confirm_subscription") {
              addLog(
                "Subscribed to " + CHANNEL + " - waiting for price updates...",
                "info",
              );
              return;
            }
            if (msg.message) {
              addLog("Price Update: " + JSON.stringify(msg.message), "price");
            }
          } catch (err) {
            addLog("Failed to parse message: " + err.message, "error");
          }
        };

        ws.onerror = (e) => {
          clearTimeout(connectionTimeout);
          addLog(
            "Connection error - check API key and WebSocket access",
            "error",
          );
        };

        ws.onclose = (e) => {
          clearTimeout(connectionTimeout);
          setStatus("disconnected");
          addLog(`Connection closed (code: ${e.code})`, "info");

          // Only auto-reconnect if we were connected before
          if (reconnectAttempts > 0 || e.code !== 1000) {
            const apiKey = document.getElementById("apiKey").value;
            if (apiKey) handleReconnect(apiKey);
          }
        };
      }

      function handleReconnect(apiKey) {
        if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
          addLog(
            `Max reconnection attempts (${MAX_RECONNECT_ATTEMPTS}) reached.`,
            "error",
          );
          return;
        }

        reconnectAttempts++;
        const delay = 1000 * Math.pow(2, reconnectAttempts - 1);
        addLog(
          `Reconnecting in ${delay / 1000}s (attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`,
          "info",
        );

        setTimeout(() => doConnect(apiKey), delay);
      }

      function disconnect() {
        clearTimeout(connectionTimeout);
        reconnectAttempts = MAX_RECONNECT_ATTEMPTS; // Prevent auto-reconnect
        if (ws) {
          ws.close();
          ws = null;
        }
      }
    </script>
  </body>
</html>
